document.addEventListener('DOMContentLoaded', () => {
    const trackingForm = document.getElementById('trackingForm');
    const projectIdField = document.getElementById('projectId');
    const jsonUbicacionesField = document.getElementById('jsonUbicaciones');
    const btnNewProject = document.getElementById('btnNewProject');
    const btnCancel = document.getElementById('btnCancel');
    const btnAddLocation = document.getElementById('btnAddLocation');

    const chkRp = document.getElementById('chkRp');
    const txtRp = document.getElementById('txtRp');
    const chkSgp = document.getElementById('chkSgp');
    const txtSgp = document.getElementById('txtSgp');
    const chkMen = document.getElementById('chkMen');
    const txtMen = document.getElementById('txtMen');
    const chkSgr = document.getElementById('chkSgr');
    const txtSgr = document.getElementById('txtSgr');
    const txtValorTotalManual = document.getElementById('txtValorTotalManual');
    const financeManualBox = document.querySelector('.finance-manual-box');
    const lblTotal = document.getElementById('lblTotal');

    const selectMunicipio = document.getElementById('selectMunicipio');
    const txtNewMunicipio = document.getElementById('txtNewMunicipio');
    const selectInstitucion = document.getElementById('selectInstitucion');
    const txtNewInstitucion = document.getElementById('txtNewInstitucion');
    const selectSede = document.getElementById('selectSede');
    const txtNewSede = document.getElementById('txtNewSede');
    const txtAvanceLocal = document.getElementById('txtAvanceLocal');
    const txtObservacionesLocal = document.getElementById('txtObservacionesLocal');
    const locationsTableBody = document.querySelector('#locationsTable tbody');

    const selectActividad = document.getElementById('selectActividad');
    const txtNuevaActividad = document.getElementById('txtNuevaActividad');
    const newActivityContainer = document.getElementById('newActivityContainer');

    const selectIndicador = document.getElementById('selectIndicador');
    const txtResponsable = document.getElementById('txtResponsable');

    let locationsList = [];
    let registeredLocations = [];
    let isExistingProject = false;

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('txtFecha').value = today;

    loadMunicipios();
    loadIndicadores();

    function updateFinanceManualVisibility() {
        const hasAnyChecked = [chkRp, chkSgp, chkMen, chkSgr].some(chk => chk.checked);
        if (financeManualBox) {
            financeManualBox.classList.toggle('hidden', hasAnyChecked);
        }
    }

    function toggleFinance(chk, input) {
        chk.addEventListener('change', () => {
            if (chk.checked) {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
                input.value = '';
                calculateTotal();
            }
            updateFinanceManualVisibility();
        });
        input.addEventListener('input', calculateTotal);
    }

    function calculateTotal() {
        const v1 = parseFloat(txtRp.value) || 0;
        const v2 = parseFloat(txtSgp.value) || 0;
        const v3 = parseFloat(txtMen.value) || 0;
        const v4 = parseFloat(txtSgr.value) || 0;
        const vManual = parseFloat(txtValorTotalManual.value) || 0;
        let total = v1 + v2 + v3 + v4;
        if (total === 0 && vManual > 0) total = vManual;
        lblTotal.textContent = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(total);
    }

    toggleFinance(chkRp, txtRp);
    toggleFinance(chkSgp, txtSgp);
    toggleFinance(chkMen, txtMen);
    toggleFinance(chkSgr, txtSgr);
    txtValorTotalManual.addEventListener('input', calculateTotal);
    updateFinanceManualVisibility();

    let pendingIndicadorId = null;
    let lockedActivityId = null;

    function setResponsableReadOnly(isReadOnly) {
        txtResponsable.readOnly = isReadOnly;
        txtResponsable.classList.toggle('input-readonly', isReadOnly);
        txtResponsable.classList.toggle('input-editable', !isReadOnly);
    }

    function setIndicadorReadOnly(isReadOnly) {
        selectIndicador.classList.toggle('input-readonly', isReadOnly);
    }

    function setActividadReadOnly(isReadOnly) {
        selectActividad.classList.toggle('input-readonly', isReadOnly);
    }

    function applyIndicadorValue(indicadorId) {
        if (!indicadorId) return;
        selectIndicador.value = indicadorId;
        if (selectIndicador.value !== String(indicadorId)) {
            pendingIndicadorId = indicadorId;
        } else {
            pendingIndicadorId = null;
        }
    }

    function clearActivityDetails() {
        selectIndicador.value = "";
        txtResponsable.value = "";
        pendingIndicadorId = null;
    }

    function loadActivityDetails(activityId, lockFields) {
        if (!activityId) return;
        fetch(`/api/activity-details/${activityId}`)
            .then(r => r.json())
            .then(d => {
                if (d && d.indicador_id) {
                    applyIndicadorValue(d.indicador_id);
                }
                if (d && d.responsable) {
                    txtResponsable.value = d.responsable.toUpperCase();
                }
                setIndicadorReadOnly(lockFields);
                setResponsableReadOnly(isExistingProject || lockFields);
            });
    }

    // Consultar sedes registradas de la actividad seleccionada
    function loadActivityLocations(activityId) {
        if (!activityId) {
            registeredLocations = [];
            renderLocationsTable();
            return;
        }
        fetch(`/api/activity-locations/${activityId}`)
            .then(r => r.json())
            .then(d => {
                registeredLocations = d || [];
                renderLocationsTable();
            });
    }

    btnAddLocation.addEventListener('click', () => {
        if (!selectMunicipio.value) return Swal.fire('Falta Municipio', 'Selecciona un municipio', 'warning');
        if (!selectInstitucion.value) return Swal.fire('Falta Instituci√≥n', 'Selecciona una instituci√≥n', 'warning');
        if (!selectSede.value) return Swal.fire('Falta Sede', 'Selecciona una sede', 'warning');
        if (txtAvanceLocal.value === '') return Swal.fire('Falta Avance', 'Ingresa el % de avance', 'warning');
        if (selectMunicipio.value.startsWith('new_') && !txtNewMunicipio.value.trim()) return Swal.fire('Falta Municipio', 'Ingresa el nombre del nuevo municipio', 'warning');
        if (selectInstitucion.value.startsWith('new_') && !txtNewInstitucion.value.trim()) return Swal.fire('Falta Instituci√≥n', 'Ingresa el nombre de la nueva instituci√≥n', 'warning');
        if (selectSede.value.startsWith('new_') && !txtNewSede.value.trim()) return Swal.fire('Falta Sede', 'Ingresa el nombre de la nueva sede', 'warning');

        const munName = selectMunicipio.value.startsWith('new_') ? txtNewMunicipio.value.toUpperCase() : selectMunicipio.options[selectMunicipio.selectedIndex].text;
        const instName = selectInstitucion.value.startsWith('new_') ? txtNewInstitucion.value.toUpperCase() : selectInstitucion.options[selectInstitucion.selectedIndex].text;
        const sedeName = selectSede.value.startsWith('new_') ? txtNewSede.value.toUpperCase() : selectSede.options[selectSede.selectedIndex].text;

        const locationObj = {
            municipio_id: selectMunicipio.value,
            institucion_id: selectInstitucion.value,
            sede_id: selectSede.value,
            nombre_municipio_nuevo: selectMunicipio.value.startsWith('new_') ? txtNewMunicipio.value.toUpperCase() : null,
            nombre_institucion_nueva: selectInstitucion.value.startsWith('new_') ? txtNewInstitucion.value.toUpperCase() : null,
            nombre_sede_nueva: selectSede.value.startsWith('new_') ? txtNewSede.value.toUpperCase() : null,
            municipio_nombre: munName,
            institucion_nombre: instName,
            sede_nombre: sedeName,
            avance: txtAvanceLocal.value,
            observaciones: txtObservacionesLocal.value.toUpperCase()
        };

        locationsList.push(locationObj);
        renderLocationsTable();

        if (selectMunicipio.value.startsWith('new_')) {
            const normalizedMun = txtNewMunicipio.value.trim().toUpperCase();
            selectMunicipio.options[selectMunicipio.selectedIndex].text = `${normalizedMun} (NUEVO)`;
            txtNewMunicipio.value = "";
            txtNewMunicipio.classList.add('hidden');
            txtNewMunicipio.required = false;
        }

        if (selectInstitucion.value.startsWith('new_')) {
            const normalizedInst = txtNewInstitucion.value.trim().toUpperCase();
            selectInstitucion.options[selectInstitucion.selectedIndex].text = `${normalizedInst} (NUEVA)`;
            txtNewInstitucion.value = "";
            txtNewInstitucion.classList.add('hidden');
            txtNewInstitucion.required = false;
        }

        if (selectSede.value.startsWith('new_')) {
            const normalizedSede = txtNewSede.value.trim().toUpperCase();
            selectSede.options[selectSede.selectedIndex].text = `${normalizedSede} (NUEVA)`;
        } else {
            selectSede.value = "";
        }
        txtNewSede.value = "";
        txtNewSede.classList.add('hidden');
        txtNewSede.required = false;
        txtAvanceLocal.value = "";
        txtObservacionesLocal.value = "";
        selectSede.focus();
    });

    function renderLocationsTable() {
        locationsTableBody.innerHTML = '';

        if (registeredLocations.length === 0 && locationsList.length === 0) {
            locationsTableBody.innerHTML = '<tr id="emptyRow"><td colspan="6" style="text-align:center; padding: 15px; color: #999;">No has agregado sedes a√∫n.</td></tr>';
            return;
        }

        registeredLocations.forEach((loc, index) => {
            const tr = document.createElement('tr');
            const avanceLabel = loc.ultimo_avance !== null && loc.ultimo_avance !== undefined ? `${loc.ultimo_avance}%` : '--';
            const ultimaFechaLabel = loc.ultima_fecha ? new Date(loc.ultima_fecha).toLocaleDateString('es-CO') : '--';
            tr.innerHTML = `
                <td style="padding: 5px;">${loc.municipio_nombre}</td>
                <td style="padding: 5px;">${loc.institucion_nombre}</td>
                <td style="padding: 5px;">${loc.sede_nombre}</td>
                <td style="padding: 5px; text-align: center;">${avanceLabel}</td>
                <td style="padding: 5px; text-align: center;">${ultimaFechaLabel}</td>
                <td style="padding: 5px; text-align: center;">
                    <button type="button" class="btn-primary btn-blue" onclick="openUpdateModal(${index})" style="padding: 2px 8px; font-size: 0.8rem; margin-right: 6px;">üìù</button>
                    <button type="button" class="btn-cancel" onclick="removeRegisteredLocation(${index})" style="padding: 2px 8px; font-size: 0.8rem;">üóëÔ∏è</button>
                </td>
            `;
            locationsTableBody.appendChild(tr);
        });

        locationsList.forEach((loc, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 5px;">${loc.municipio_nombre}</td>
                <td style="padding: 5px;">${loc.institucion_nombre}</td>
                <td style="padding: 5px;">${loc.sede_nombre}</td>
                <td style="padding: 5px; text-align: center;">${loc.avance}%</td>
                <td style="padding: 5px; text-align: center;">--</td>
                <td style="padding: 5px; text-align: center;">
                <button type="button" class="btn-cancel" onclick="removeLocation(${index})" style="padding: 2px 8px; font-size: 0.8rem;">üóëÔ∏è</button>
                </td>
            `;
            locationsTableBody.appendChild(tr);
        });
    }

    window.removeLocation = (index) => {
        locationsList.splice(index, 1);
        renderLocationsTable();
    };

    window.removeRegisteredLocation = (index) => {
        registeredLocations.splice(index, 1);
        renderLocationsTable();
    };

    window.openUpdateModal = (index) => {
        const loc = registeredLocations[index];
        if (!loc) return;

        Swal.fire({
            title: `Actualizar sede: ${loc.sede_nombre}`,
            html: `
                <input id="swal-avance" class="swal2-input" type="number" min="0" max="100" step="0.01" placeholder="% avance">
                <input id="swal-responsable" class="swal2-input" type="text" placeholder="Responsable" value="${txtResponsable.value || ''}">
                <textarea id="swal-observaciones" class="swal2-textarea" placeholder="Observaciones"></textarea>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Agregar actualizaci√≥n',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const avance = document.getElementById('swal-avance').value;
                const responsable = document.getElementById('swal-responsable').value;
                const observaciones = document.getElementById('swal-observaciones').value;
                if (avance === '') {
                    Swal.showValidationMessage('Debes ingresar el % de avance.');
                    return false;
                }
                if (!responsable.trim()) {
                    Swal.showValidationMessage('Debes ingresar el responsable.');
                    return false;
                }
                return { avance, observaciones, responsable };
            }
        }).then((result) => {
            if (!result.isConfirmed) return;
            txtResponsable.value = result.value.responsable.toUpperCase();
            const obsText = result.value.observaciones ? result.value.observaciones.toUpperCase() : '';
            const locationObj = {
                municipio_id: loc.municipio_id,
                institucion_id: loc.institucion_id,
                sede_id: loc.sede_id,
                nombre_municipio_nuevo: null,
                nombre_institucion_nueva: null,
                nombre_sede_nueva: null,
                municipio_nombre: loc.municipio_nombre,
                institucion_nombre: loc.institucion_nombre,
                sede_nombre: loc.sede_nombre,
                avance: result.value.avance,
                observaciones: obsText
            };
            locationsList.push(locationObj);
            renderLocationsTable();
        });
    };

    const submitTrackingData = async (payload) => {
        const res = await fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const resp = await res.json();
        return { res, resp };
    };

    trackingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (locationsList.length === 0) {
            return Swal.fire('Lista Vac√≠a', 'Debes agregar al menos una sede a la lista (Bot√≥n Naranja) antes de guardar.', 'warning');
        }

        jsonUbicacionesField.value = JSON.stringify(locationsList);
        const formData = new FormData(trackingForm);
        const data = Object.fromEntries(formData.entries());
        data.es_adicion = document.getElementById('chkAdicion').checked ? 'on' : 'off';

        try {
            let { res, resp } = await submitTrackingData(data);

            if (res.status === 409 && resp.existing_project) {
                const existingName = resp.existing_project.nombre;
                const incomingName = resp.incoming_name || data.nombre_proyecto;
                const result = await Swal.fire({
                    icon: 'warning',
                    title: 'Nombre de proyecto parecido detectado',
                    html: `Ya existe un proyecto similar:<br><b>${existingName}</b><br><br>Nuevo nombre:<br><b>${incomingName}</b>`,
                    showCancelButton: true,
                    confirmButtonText: 'Usar existente',
                    cancelButtonText: 'Crear nuevo de todas formas',
                    reverseButtons: true
                });

                if (result.isConfirmed) {
                    data.proyecto_id = resp.existing_project.id;
                    ({ res, resp } = await submitTrackingData(data));
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    data.force_create_similar_name = 'true';
                    ({ res, resp } = await submitTrackingData(data));
                } else {
                    return;
                }
            }
            if (resp.success) {
                Swal.fire('√âxito', resp.message, 'success').then(() => {
                    resetForm();
                    trackingForm.classList.add('hidden');
                });
            } else {
                Swal.fire('Error', resp.error || 'No fue posible guardar la informaci√≥n.', 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Fallo de red', 'error');
        }
    });

    function resetForm() {
        trackingForm.reset();
        document.getElementById('txtFecha').value = today;
        projectIdField.value = '';
        locationsList = [];
        registeredLocations = [];
        lockedActivityId = null;
        pendingIndicadorId = null;
        isExistingProject = false;
        renderLocationsTable();
        // Reiniciar el selector de actividades con las opciones por defecto.
        selectActividad.innerHTML = '<option value="">-- SELECCIONE --</option><option value="new_activity">‚ûï NUEVA ACTIVIDAD...</option>';
        // Limpiar estado asociado a la actividad para evitar datos previos visibles.
        newActivityContainer.classList.add('hidden');
        txtNuevaActividad.required = false;
        txtNuevaActividad.value = '';
        txtNewMunicipio.classList.add('hidden');
        txtNewInstitucion.classList.add('hidden');
        txtNewSede.classList.add('hidden');
        txtRp.classList.add('hidden');
        txtSgp.classList.add('hidden');
        txtMen.classList.add('hidden');
        txtSgr.classList.add('hidden');
        lblTotal.textContent = '$0';
        updateFinanceManualVisibility();
        clearLocationFields();
        setResponsableReadOnly(true);
        setIndicadorReadOnly(false);
        setActividadReadOnly(false);
    }

    if (btnNewProject) {
        btnNewProject.onclick = () => {
            resetForm();
            isExistingProject = false;
            trackingForm.classList.remove('hidden');
            document.querySelectorAll('#projectInfoSection input').forEach(el => {
                el.readOnly = false;
                el.style.backgroundColor = '#fff';
            });
            [chkRp, chkSgp, chkMen, chkSgr].forEach(el => el.disabled = false);
            setResponsableReadOnly(false);
            setIndicadorReadOnly(false);
            setActividadReadOnly(false);
            document.getElementById('txtBpin').focus();
        };
    }

    if (btnCancel) btnCancel.onclick = () => {
        resetForm();
        trackingForm.classList.add('hidden');
    };

    let debounce;
    const searchInput = document.getElementById('searchBpin');
    const resultsList = document.getElementById('searchResults');

    searchInput.addEventListener('input', (e) => {
        const q = e.target.value.trim();
        clearTimeout(debounce);
        if (q.length < 1) {
            resultsList.classList.add('hidden');
            return;
        }
        debounce = setTimeout(() => {
            fetch(`/api/search?q=${q}`)
                .then(r => r.json())
                .then(d => {
                    resultsList.innerHTML = '';
                    if (d.length) {
                        d.forEach(p => {
                            const li = document.createElement('li');
                            li.textContent = `${p.codigo_bpin} - ${p.nombre_proyecto}`;
                            li.onclick = () => selectProject(p.nombre_proyecto);
                            resultsList.appendChild(li);
                        });
                        resultsList.classList.remove('hidden');
                    } else {
                        resultsList.classList.add('hidden');
                    }
                });
        }, 300);
    });

    function selectProject(bpin) {
        searchInput.value = '';
        resultsList.classList.add('hidden');
        fetch(`/api/project/${bpin}`)
            .then(r => {
                if (!r.ok) throw new Error(`No se pudo cargar el proyecto (HTTP ${r.status})`);
                return r.json();
            })
            .then(d => {
                if (!d.found) {
                    Swal.fire('Proyecto no encontrado', 'No se encontraron datos para la b√∫squeda seleccionada.', 'info');
                    return;
                }

                resetForm();
                isExistingProject = true;
                trackingForm.classList.remove('hidden');
                const p = d.project;
                projectIdField.value = p.id;
                document.getElementById('txtBpin').value = p.codigo_bpin;
                document.getElementById('txtAnio').value = p.anio_contrato;
                document.getElementById('txtNombre').value = p.nombre_proyecto;
                document.getElementById('txtContratista').value = p.contratista;
                if (p.valor_rp) {
                    chkRp.checked = true;
                    txtRp.value = p.valor_rp;
                    txtRp.classList.remove('hidden');
                }
                if (p.valor_sgp) {
                    chkSgp.checked = true;
                    txtSgp.value = p.valor_sgp;
                    txtSgp.classList.remove('hidden');
                }
                if (p.valor_men) {
                    chkMen.checked = true;
                    txtMen.value = p.valor_men;
                    txtMen.classList.remove('hidden');
                }
                if (p.valor_sgr) {
                    chkSgr.checked = true;
                    txtSgr.value = p.valor_sgr;
                    txtSgr.classList.remove('hidden');
                }
                if (!p.valor_rp && !p.valor_sgp && !p.valor_men && !p.valor_sgr && p.valor_inicial > 0) {
                    txtValorTotalManual.value = p.valor_inicial;
                }
                calculateTotal();
                updateFinanceManualVisibility();
                document.querySelectorAll('#projectInfoSection input').forEach(el => {
                    el.readOnly = true;
                    el.style.backgroundColor = '#e9ecef';
                });
                [chkRp, chkSgp, chkMen, chkSgr].forEach(el => el.disabled = true);
                txtValorTotalManual.readOnly = true;

                const activities = Array.isArray(d.activities) ? d.activities : [];
                selectActividad.innerHTML = '<option value="">-- SELECCIONE --</option>';
                lockedActivityId = null;
                if (activities.length === 1) {
                    const singleActivity = activities[0];
                    selectActividad.appendChild(new Option(singleActivity.descripcion, singleActivity.id));
                    selectActividad.appendChild(new Option('‚ûï NUEVA ACTIVIDAD...', 'new_activity'));
                    selectActividad.value = singleActivity.id;
                    lockedActivityId = singleActivity.id;
                    setActividadReadOnly(false);
                    loadActivityDetails(singleActivity.id, true);
                    loadActivityLocations(singleActivity.id);
                } else if (activities.length > 1) {
                    activities.forEach(a => selectActividad.appendChild(new Option(a.descripcion, a.id)));
                    selectActividad.appendChild(new Option('‚ûï NUEVA ACTIVIDAD...', 'new_activity'));
                    const firstActivity = activities[0];
                    selectActividad.value = firstActivity.id;
                    loadActivityDetails(firstActivity.id, true);
                    loadActivityLocations(firstActivity.id);
                    setActividadReadOnly(false);
                    setIndicadorReadOnly(true);
                    setResponsableReadOnly(true);
                } else {
                    selectActividad.appendChild(new Option('‚ûï NUEVA ACTIVIDAD...', 'new_activity'));
                    setActividadReadOnly(false);
                    setIndicadorReadOnly(false);
                    setResponsableReadOnly(true);
                    registeredLocations = [];
                    renderLocationsTable();
                }

                const validActivityIds = new Set(activities.map(a => String(a.id)));
                const inconsistentLocations = (d.locations || []).filter(loc => loc && loc.actividad_id && !validActivityIds.has(String(loc.actividad_id)));
                if (inconsistentLocations.length > 0) {
                    console.warn('[Integridad] Seguimientos con actividad_id sin correspondencia en actividades del proyecto.', inconsistentLocations);
                    Swal.fire('Warning de integridad', `Se detectaron ${inconsistentLocations.length} registro(s) con actividad_id sin correspondencia. Revisa consola para diagn√≥stico.`, 'warning');
                }
            })
            .catch(err => {
                console.error('Error cargando proyecto:', err);
                Swal.fire('Error', err.message || 'No fue posible cargar el proyecto.', 'error');
            });
    }

    function handleNewInput(select, input, nextSelect, nextNewValue) {
        if (select.value.startsWith('new_')) {
            input.classList.remove('hidden');
            input.required = true;
            input.focus();
            if (nextSelect) {
                nextSelect.innerHTML = `<option value="${nextNewValue}">‚ûï AGREGAR NUEVO...</option>`;
                nextSelect.value = nextNewValue;
                nextSelect.disabled = false;
                nextSelect.dispatchEvent(new Event('change'));
            }
        } else {
            input.classList.add('hidden');
            input.required = false;
        }
    }

    selectMunicipio.addEventListener('change', () => {
        handleNewInput(selectMunicipio, txtNewMunicipio, selectInstitucion, 'new_institucion');
        if (!selectMunicipio.value) {
            selectInstitucion.innerHTML = '<option value="">-- SELECCIONE --</option>';
            selectInstitucion.disabled = true;
            txtNewInstitucion.classList.add('hidden');
            txtNewInstitucion.required = false;
            selectSede.innerHTML = '<option value="">-- SELECCIONE --</option>';
            selectSede.disabled = true;
            txtNewSede.classList.add('hidden');
            txtNewSede.required = false;
            return;
        }
        if (selectMunicipio.value && !selectMunicipio.value.startsWith('new_')) {
            loadMunicipiosChildren(selectMunicipio.value, 'instituciones');
        }
    });

    selectInstitucion.addEventListener('change', () => {
        handleNewInput(selectInstitucion, txtNewInstitucion, selectSede, 'new_sede');
        if (!selectInstitucion.value) {
            selectSede.innerHTML = '<option value="">-- SELECCIONE --</option>';
            selectSede.disabled = true;
            txtNewSede.classList.add('hidden');
            txtNewSede.required = false;
            return;
        }
        if (selectInstitucion.value && !selectInstitucion.value.startsWith('new_')) {
            loadMunicipiosChildren(selectInstitucion.value, 'sedes');
        }
    });

    selectSede.addEventListener('change', () => handleNewInput(selectSede, txtNewSede, null, null));

    selectActividad.addEventListener('change', () => {
        const val = selectActividad.value;
        if (val === 'new_activity') {
            newActivityContainer.classList.remove('hidden');
            txtNuevaActividad.required = true;
            txtNuevaActividad.focus();
            setIndicadorReadOnly(false);
            setResponsableReadOnly(false);
            // Al crear una nueva actividad, limpiamos las sedes registradas en la tabla
            registeredLocations = [];
            renderLocationsTable();
            return;
        }
        newActivityContainer.classList.add('hidden');
        txtNuevaActividad.required = false;
        if (val) {
            loadActivityDetails(val, true);
            // Al seleccionar actividad, actualizamos las sedes desde el nuevo endpoint
            loadActivityLocations(val);
        } else {
            clearActivityDetails();
            setIndicadorReadOnly(false);
            setResponsableReadOnly(isExistingProject);
            // Si no hay actividad seleccionada, vaciamos la tabla
            registeredLocations = [];
            renderLocationsTable();
        }
    });

    function loadMunicipios() {
        fetch('/api/municipios')
            .then(r => r.json())
            .then(d => populateSelect(selectMunicipio, d, 'new_municipio'));
    }

    function loadMunicipiosChildren(id, type) {
        const url = type === 'instituciones' ? `/api/instituciones/${id}` : `/api/sedes/${id}`;
        const target = type === 'instituciones' ? selectInstitucion : selectSede;
        const nextNew = type === 'instituciones' ? 'new_institucion' : 'new_sede';
        fetch(url)
            .then(r => r.json())
            .then(d => {
                populateSelect(target, d, nextNew);
                target.disabled = false;
            });
    }

    function loadIndicadores() {
        fetch('/api/indicadores')
            .then(r => r.json())
            .then(d => {
                populateSelect(selectIndicador, d);
                if (pendingIndicadorId) {
                    applyIndicadorValue(pendingIndicadorId);
                }
            });
    }

    function populateSelect(el, items, newOptionValue) {
        el.innerHTML = '<option value="">-- SELECCIONE --</option>';
        items.forEach(i => el.appendChild(new Option(i.nombre, i.id)));
        if (newOptionValue) el.appendChild(new Option('‚ûï AGREGAR NUEVO...', newOptionValue));
    }

    function clearLocationFields() {
        selectMunicipio.value = "";
        selectInstitucion.innerHTML = "";
        selectInstitucion.disabled = true;
        selectSede.innerHTML = "";
        selectSede.disabled = true;
    }

    const chkAdicion = document.getElementById('chkAdicion');
    const adicionFields = document.getElementById('adicionFields');
    chkAdicion.addEventListener('change', () => {
        if (chkAdicion.checked) adicionFields.classList.remove('hidden');
        else adicionFields.classList.add('hidden');
    });

    document.getElementById('btnCleanDB').addEventListener('click', async (e) => {
        e.preventDefault();

        const confirm = await Swal.fire({
            title: '¬øEst√°s seguro?',
            text: 'Esto eliminar√° TODOS los datos.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'S√≠, borrar',
            cancelButtonText: 'Cancelar'
        });

        if (!confirm.isConfirmed) return;

        try {
            const r = await fetch('/api/cleanDB', { method: 'POST' });

            if (!r.ok) throw new Error('Error HTTP ' + r.status);

            const d = await r.json();

            if (d.success) {
                Swal.fire('√âxito', d.message, 'success');
            } else {
                throw new Error(d.error);
            }
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        }
    });

    

    const modal = document.getElementById('uploadModal');
    const uStatus = document.getElementById('uploadStatus');
    document.getElementById('btnOpenUpload').onclick = () => {
        modal.classList.remove('hidden');
        uStatus.innerHTML = '';
    };
    document.getElementsByClassName('close-modal')[0].onclick = () => modal.classList.add('hidden');
    document.getElementById('uploadForm').onsubmit = (e) => {
        e.preventDefault();
        uStatus.innerHTML = 'Procesando...';
        fetch('/api/upload-excel', { method: 'POST', body: new FormData(e.target) })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    if (d.errors && d.errors.length) {
                        Swal.fire({ icon: 'warning', title: 'Advertencias', html: d.errors.join('<br>') });
                    } else {
                        Swal.fire('√âxito', d.message, 'success');
                    }
                    modal.classList.add('hidden');
                } else {
                    uStatus.innerHTML = d.error;
                }
            });
    };

    document.getElementById('btnExport').onclick = async () => {
        const result = await Swal.fire({
            title: 'Exportar Excel',
            text: '¬øQu√© deseas descargar?',
            icon: 'question',
            showCancelButton: true,
            showDenyButton: true,
            confirmButtonText: 'Plantilla carga masiva',
            denyButtonText: 'Informaci√≥n almacenada',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            window.location.href = '/api/export-excel-template';
            return;
        }

        if (result.isDenied) {
            window.location.href = '/api/export-excel';
        }
    };
});
document.addEventListener('DOMContentLoaded', () => {
    const lblTotalProyectos = document.getElementById('lblTotalProyectos');
    const lblTotalInversion = document.getElementById('lblTotalInversion');
    const lblTotalSedes = document.getElementById('lblTotalSedes');
    const lblPromedioAvance = document.getElementById('lblPromedioAvance');
    const lblEstadoGrafica = document.getElementById('lblEstadoGrafica');
    const commentsPanel = document.getElementById('commentsPanel');

    const filtroIndicador = document.getElementById('filtroIndicador');
    const filtroProyecto = document.getElementById('filtroProyecto');
    const filtroActividad = document.getElementById('filtroActividad');
    const filtroMunicipio = document.getElementById('filtroMunicipio');
    const filtroInstitucion = document.getElementById('filtroInstitucion');
    const filtroSede = document.getElementById('filtroSede');
    const btnLimpiar = document.getElementById('btnLimpiarFiltros');

    let evolutionChart = null;
    let evolutionRows = [];

    init();

    async function init() {
        await loadIndicadores();
        resetStats();
        clearChart();
    }

    async function loadIndicadores() {
        try {
            const res = await fetch('/api/indicadores');
            const data = await res.json();
            fillSelect(filtroIndicador, data, 'Seleccione un Indicador');
        } catch (error) {
            console.error('Error cargando indicadores:', error);
        }
    }

    function fillSelect(select, items, placeholder) {
        select.innerHTML = '';
        select.add(new Option(placeholder, ''));
        items.forEach(item => select.add(new Option(item.nombre, item.id)));
    }

    function disableSelect(select, placeholder) {
        fillSelect(select, [], placeholder);
        select.disabled = true;
    }

    function resetStats() {
        lblTotalProyectos.textContent = '0';
        lblTotalInversion.textContent = '$0';
        lblTotalSedes.textContent = '0';
        lblPromedioAvance.textContent = '0%';
    }

    function clearChart() {
        if (evolutionChart) evolutionChart.destroy();
        const ctx = document.getElementById('chartEvolution').getContext('2d');
        evolutionChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: '% Avance Promedio', data: [] }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
        evolutionRows = [];
        commentsPanel.textContent = 'No hay comentarios para mostrar.';
    }

    function getFilters() {
        return {
            indicador_id: filtroIndicador.value,
            proyecto_id: filtroProyecto.value,
            actividad_id: filtroActividad.value,
            municipio_id: filtroMunicipio.value,
            institucion_id: filtroInstitucion.value,
            sede_id: filtroSede.value
        };
    }

    function filtersToParams(filters) {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
            if (value) params.set(key, value);
        });
        return params;
    }

    async function updateStatsAndChart() {
        const filters = getFilters();
        if (!filters.indicador_id) {
            resetStats();
            clearChart();
            lblEstadoGrafica.textContent = 'Seleccione un indicador para visualizar la trazabilidad.';
            return;
        }

        try {
            const params = filtersToParams(filters).toString();

            const statsRes = await fetch(`/api/stats/general?${params}`);
            const stats = await statsRes.json();
            lblTotalProyectos.textContent = stats.total_proyectos || 0;
            lblTotalInversion.textContent = new Intl.NumberFormat('es-CO', {
                style: 'currency', currency: 'COP', maximumFractionDigits: 0
            }).format(stats.total_inversion || 0);
            lblTotalSedes.textContent = stats.total_sedes || 0;
            lblPromedioAvance.textContent = `${Number(stats.promedio_avance_global || 0).toFixed(1)}%`;

            const evoRes = await fetch(`/api/stats/evolution?${params}`);
            evolutionRows = await evoRes.json();
            drawEvolutionChart(evolutionRows);
            lblEstadoGrafica.textContent = evolutionRows.length
                ? 'Haga clic en un punto para revisar los comentarios asociados.'
                : 'No hay datos para los filtros seleccionados.';
            commentsPanel.textContent = 'No hay comentarios para mostrar.';
        } catch (error) {
            console.error('Error actualizando panel estadístico:', error);
        }
    }

    function drawEvolutionChart(rows) {
        if (evolutionChart) evolutionChart.destroy();
        const ctx = document.getElementById('chartEvolution').getContext('2d');

        evolutionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: rows.map(row => row.fecha_seguimiento),
                datasets: [{
                    label: '% Avance Promedio',
                    data: rows.map(row => Number(row.avance_promedio || 0)),
                    borderColor: '#005f27',
                    backgroundColor: 'rgba(0, 95, 39, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 100, title: { display: true, text: '% Porcentaje' } },
                    x: { title: { display: true, text: 'Fecha de Seguimiento' } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: ctxTooltip => `${Number(ctxTooltip.raw || 0).toFixed(2)}%`
                        }
                    }
                },
                onClick: (_event, elements) => {
                    if (!elements.length) return;
                    const index = elements[0].index;
                    renderComments(rows[index]);
                }
            }
        });
    }

    function renderComments(row) {
        const comments = (row.comentarios || '')
            .split(',')
            .map(item => item.trim())
            .filter(Boolean);

        if (!comments.length) {
            commentsPanel.textContent = `Sin comentarios para ${row.fecha_seguimiento}.`;
            return;
        }

        commentsPanel.innerHTML = comments
            .map(comment => `<div class="comment-item">• ${comment}</div>`)
            .join('');
    }

    filtroIndicador.addEventListener('change', async () => {
        disableSelect(filtroProyecto, 'Seleccione un Proyecto');
        disableSelect(filtroActividad, 'Seleccione una Actividad');
        disableSelect(filtroMunicipio, 'Seleccione un Municipio');
        disableSelect(filtroInstitucion, 'Seleccione una Institución');
        disableSelect(filtroSede, 'Seleccione una Sede');

        if (filtroIndicador.value) {
            const params = new URLSearchParams({ indicador_id: filtroIndicador.value });
            const res = await fetch(`/api/filtros/proyectos?${params}`);
            const data = await res.json();
            fillSelect(filtroProyecto, data, 'Seleccione un Proyecto');
            filtroProyecto.disabled = false;
        }

        updateStatsAndChart();
    });

    filtroProyecto.addEventListener('change', async () => {
        disableSelect(filtroActividad, 'Seleccione una Actividad');
        disableSelect(filtroMunicipio, 'Seleccione un Municipio');
        disableSelect(filtroInstitucion, 'Seleccione una Institución');
        disableSelect(filtroSede, 'Seleccione una Sede');

        if (filtroIndicador.value && filtroProyecto.value) {
            const params = new URLSearchParams({ indicador_id: filtroIndicador.value, proyecto_id: filtroProyecto.value });
            const res = await fetch(`/api/filtros/actividades?${params}`);
            const data = await res.json();
            fillSelect(filtroActividad, data, 'Seleccione una Actividad');
            filtroActividad.disabled = false;
        }

        updateStatsAndChart();
    });

    filtroActividad.addEventListener('change', async () => {
        disableSelect(filtroMunicipio, 'Seleccione un Municipio');
        disableSelect(filtroInstitucion, 'Seleccione una Institución');
        disableSelect(filtroSede, 'Seleccione una Sede');

        if (filtroIndicador.value && filtroProyecto.value && filtroActividad.value) {
            const params = new URLSearchParams({
                indicador_id: filtroIndicador.value,
                proyecto_id: filtroProyecto.value,
                actividad_id: filtroActividad.value
            });
            const res = await fetch(`/api/filtros/municipios?${params}`);
            const data = await res.json();
            fillSelect(filtroMunicipio, data, 'Seleccione un Municipio');
            filtroMunicipio.disabled = false;
        }

        updateStatsAndChart();
    });

    filtroMunicipio.addEventListener('change', async () => {
        disableSelect(filtroInstitucion, 'Seleccione una Institución');
        disableSelect(filtroSede, 'Seleccione una Sede');

        if (filtroIndicador.value && filtroProyecto.value && filtroActividad.value && filtroMunicipio.value) {
            const params = new URLSearchParams({
                indicador_id: filtroIndicador.value,
                proyecto_id: filtroProyecto.value,
                actividad_id: filtroActividad.value,
                municipio_id: filtroMunicipio.value
            });
            const res = await fetch(`/api/filtros/instituciones?${params}`);
            const data = await res.json();
            fillSelect(filtroInstitucion, data, 'Seleccione una Institución');
            filtroInstitucion.disabled = false;
        }

        updateStatsAndChart();
    });

    filtroInstitucion.addEventListener('change', async () => {
        disableSelect(filtroSede, 'Seleccione una Sede');

        if (filtroIndicador.value && filtroProyecto.value && filtroActividad.value && filtroInstitucion.value) {
            const params = new URLSearchParams({
                indicador_id: filtroIndicador.value,
                proyecto_id: filtroProyecto.value,
                actividad_id: filtroActividad.value,
                institucion_id: filtroInstitucion.value
            });
            const res = await fetch(`/api/filtros/sedes?${params}`);
            const data = await res.json();
            fillSelect(filtroSede, data, 'Seleccione una Sede');
            filtroSede.disabled = false;
        }

        updateStatsAndChart();
    });

    filtroSede.addEventListener('change', updateStatsAndChart);

    btnLimpiar.addEventListener('click', () => {
        filtroIndicador.value = '';
        disableSelect(filtroProyecto, 'Seleccione un Proyecto');
        disableSelect(filtroActividad, 'Seleccione una Actividad');
        disableSelect(filtroMunicipio, 'Seleccione un Municipio');
        disableSelect(filtroInstitucion, 'Seleccione una Institución');
        disableSelect(filtroSede, 'Seleccione una Sede');
        resetStats();
        clearChart();
        lblEstadoGrafica.textContent = 'Seleccione un indicador para visualizar la trazabilidad.';
    });
});